<p-stepper (activeStepChange)="onStepChange($event)" class="p-10">
  <p-stepperPanel header="Select data">
    <ng-template
      pTemplate="content"
      let-nextCallback="nextCallback"
      let-index="index">
      <label for="template" class="text-3xl font-bold">Choose a type</label>

      <div class="grid grid-cols-2 gap-x-8 mb-10">
        <div class="basis-1/2">
          <div
            gSearchContext="newDataTemplates"
            size="5"
            filter="+isTemplate:y"
            [sort]="[{ 'resourceTitleObject.default.sort': 'desc' }]">
            <p-dropdown
              styleClass="w-full"
              gSearchResultsLoader="newDataTemplates"
              [(ngModel)]="template"
              placeholder="" />
            <input
              pInputText
              id="template"
              class="hidden"
              aria-describedby="template-help"
              [(ngModel)]="template" />
          </div>
        </div>
        <div class="basis-1/2">
          Choose a type of data to describe (eg. geospatial, tabular,
          statistical, maps).
        </div>
      </div>

      <label for="datasource" class="text-3xl font-bold"
        >Upload or connect your data</label
      >

      <div class="grid grid-cols-2 gap-x-8 mb-10">
        <div class="basis-1/2">
          <p-inputGroup>
            <p-inputGroupAddon>
              <i class="fa fa-link"></i>
              URL
            </p-inputGroupAddon>
            <input
              pInputText
              id="datasource"
              aria-describedby="datasource-help"
              (change)="onDatasourceChange()"
              [(ngModel)]="datasource" />
            <button
              type="button"
              pButton
              label="Find datasets"
              [disabled]="isFetchingLayers()"
              (click)="retrieveLayers()"></button>
          </p-inputGroup>

          <div class="font-bold w-full text-2xl text-center">or</div>

          <div class="mb-10">
            <p-fileUpload
              styleClass="w-full"
              mode="basic"
              name="demo[]"
              chooseIcon="fa fa-upload"
              accept="image/*"
              maxFileSize="1000000"
              (onUpload)="onBasicUploadAuto($event)"
              [auto]="true"
              chooseLabel="Upload your file" />
          </div>

          @if (isFetchingLayers()) {
            <div>
              <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
            </div>
          }

          @if (errorFetchingLayers()) {
            <p class="error-message">
              An error occurred retrieving dataset information. Please try
              later.
            </p>
            <small class="error-message"
              >Error is: {{ errorFetchingLayers() }}</small
            >
          }

          @if (layers().length > 0) {
            <div title=" Select the dataset name to analyse">
              <label for="layername" class="w-full"
                >{{ layers().length }} dataset(s) found</label
              >
              <p-dropdown
                id="layername"
                styleClass="w-full"
                disabled="{{ layers().length === 0 }}"
                [options]="layers()"
                [(ngModel)]="layername"
                (onChange)="onLayerChange()"
                placeholder="Select a dataset" />
            </div>
          }
        </div>
        <div class="basis-1/2">
          <span
            >Point to the datasource URL or upload a new file and select the
            dataset to register.</span
          >

          <h2 class="font-medium mt-10">Supported data formats:</h2>
          @for (format of mainSupportedFormats(); track format) {
            <p-chip
              [title]="format.description + ' - ' + format.dataType"
              [label]="format.name"
              class="mr-2"></p-chip>
          }

          <h2 class="font-medium mt-10">
            Maximum file size is <span class="font-bold">100Mo</span>.
          </h2>
        </div>
      </div>

      <div class="flex mt-2 gap-2 flex-row-reverse">
        <p-button
          [disabled]="!isDatasourceAndTemplateSelected()"
          label="Analyze dataset"
          icon="fas fa-arrow-right"
          iconPos="right"
          (onClick)="nextCallback.emit()" />
      </div>
    </ng-template>
  </p-stepperPanel>

  <p-stepperPanel header="Scan & Analysis">
    <ng-template
      pTemplate="content"
      let-prevCallback="prevCallback"
      let-nextCallback="nextCallback"
      let-index="index">
      <div>
        @if (isExecutingAnalysis()) {
          <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
        }
        @if (errorExecutingAnalysis()) {
          <p class="error-message">
            An error analysing the dataset information. Please try later.
          </p>
          <small class="error-message">{{ errorExecutingAnalysis() }}</small>
        } @else if (analysisResult()) {
          <h2 class="pt-2 pb-2 text-2xl font-medium">
            <span class="font-bold">{{ analysisResult().layers[0].name }}</span>
            dataset contains
            <span class="font-bold">{{
              analysisResult().layers[0].featureCount
            }}</span>
            features.
          </h2>

          <div class="grid grid-cols-8 gap-4">
            <div><strong>Source</strong></div>
            <div class="col-span-7">{{ analysisResult().description }}</div>

            <div><strong>Format</strong></div>
            <div class="col-span-7">{{ analysisResult().format }}</div>

            @if (analysisResult().layers[0].geometryFields.length > 0) {
              <div><strong>Geometry type</strong></div>
              <div class="col-span-7">
                {{ analysisResult().layers[0].geometryFields[0].type }}
              </div>

              <div><strong>Coordinate system</strong></div>
              <div class="col-span-7">
                <a href="http://epsg.io/{{ crsCode() }}" target="_blank"
                  >EPSG:{{ crsCode() }}</a
                >
              </div>

              <div><strong>Spatial extent</strong></div>
              <div class="col-span-7">
                {{ analysisResult().layers[0].geometryFields[0].extent }}
              </div>
            }

            <div><strong>Data model</strong></div>
            <div class="col-span-7">
              <p-table
                [value]="analysisResult().layers[0].fields"
                styleClass="w-full"
                tableStyleClass="w-full">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Column name</th>
                    <th>Column type</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-field>
                  <tr>
                    <td>{{ field.name }}</td>
                    <td>{{ field.type }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            @if (analysisResult().layers[0].geometryFields.length == 0) {
              <div><strong>Spatial extent?</strong></div>
              <div class="col-span-7">
                <p-dropdown
                  [options]="analysisResult().layers[0].fields"
                  placeholder="Compute spatial extent from attribute"
                  optionLabel="name"
                  optionValue="name" />
              </div>
            }
            <div><strong>Temporal extent?</strong></div>
            <div class="col-span-7">
              <p-dropdown
                [options]="analysisResult().layers[0].fields"
                placeholder="Compute temporal extent from attribute"
                optionLabel="name"
                optionValue="name" />
            </div>

            <div><strong>Vertical extent?</strong></div>
            <div class="col-span-7">
              <p-dropdown
                [options]="analysisResult().layers[0].fields"
                placeholder="Compute vertical extent from attribute"
                optionLabel="name"
                optionValue="name" />
            </div>
          </div>
        }
      </div>
      <div class="flex mt-2 gap-2">
        <p-button
          label="Back"
          icon="fas fa-arrow-left"
          severity="secondary"
          (onClick)="prevCallback.emit()" />
        <p-button
          [disabled]="!analysisResult()"
          label="Preview record"
          icon="fas fa-arrow-right"
          iconPos="right"
          (onClick)="nextCallback.emit()" />
      </div>
    </ng-template>
  </p-stepperPanel>

  <p-stepperPanel header="Review and save">
    <ng-template
      pTemplate="content"
      let-prevCallback="prevCallback"
      let-index="index">
      <div>
        @if (isCreatingPreview()) {
          <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
        } @else if (previewResult()) {
          <ace
            style="height: 50vh"
            [config]="{ wrap: true, tabSize: 2 }"
            [mode]="'xml'"
            [theme]="'github'"
            [(value)]="previewResult"
            [disabled]="true"></ace>
        }
      </div>
      <div class="flex mt-2 gap-2">
        <p-button
          label="Back"
          severity="secondary"
          icon="fas fa-arrow-left"
          (onClick)="prevCallback.emit()" />
        <p-button
          label="Save"
          icon="fas fa-save"
          [disabled]="!previewResult()" />
      </div>
    </ng-template>
  </p-stepperPanel>
  -
</p-stepper>
